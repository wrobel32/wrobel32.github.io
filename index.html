<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System sprawdzania obecno≈õci</title>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: #d0d1d4;
            color: #333;
        }

        header {
            background: linear-gradient(135deg, #714bb7, #2a1848);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .container {
            display: flex;
            min-height: 80vh;
            gap: 20px;
        }

        nav {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        main {
            flex: 3;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h1,
        h2,
        h3 {
            margin-top: 0;
        }

        button {
            background-color: #5f4bb7;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #613a9f;
        }

        input,
        select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            margin: 5px 0 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #f1f5f9;
        }

        .attendance-present {
            color: #28a745;
        }

        .attendance-absent {
            color: #dc3545;
        }

        .attendance-excused {
            color: #ffc107;
        }

        .nav-link {
            display: block;
            padding: 10px;
            text-decoration: none;
            color: #333;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: #eef2f7;
            color: #624bb7;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item:hover {
            background-color: #e9ecef;
        }

        .stats-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: #dc3545;
            color: white;
            font-size: 0.8em;
        }

        .session-item {
            padding: 8px;
            background-color: #eef2f7;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .session-item:hover {
            background-color: #e2e6ea;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            background-color: #6c757d;
            color: white;
        }

        .stats-good {
            background-color: #28a745 !important;
        }

        .stats-medium {
            background-color: #ffc107 !important;
        }

        .stats-bad {
            background-color: #dc3545 !important;
        }

        .warning-icon {
            color: #dc3545;
            font-weight: bold;
            font-size: 1.2em;
        }

        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .badge-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-weight: bold;
            color: white;
        }

        .present-badge {
            background-color: #28a745;
        }

        .absent-badge {
            background-color: #dc3545;
        }

        .absent-high-badge {
            background-color: #007bff;
        }

        .excused-badge {
            background-color: #ffc107;
        }

        .person-detail-row {
            background-color: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .person-info {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .person-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2a1848;
        }

        .person-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .person-meta div {
            display: flex;
            align-items: center;
        }

        .person-meta strong {
            margin-right: 5px;
            color: #333;
        }

        .function-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e9ecef;
            padding: 6px 12px;
            border-radius: 20px;
            margin: 5px 5px 5px 0;
            font-size: 0.9em;
            gap: 5px;
        }

        .function-tag .remove-function {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
            padding: 0;
            font-size: 1.1em;
        }

        .function-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .function-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .list-assignment {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .list-select {
            width: 100%;
        }

        .functions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .function-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 200px;
        }

        .function-card h3 {
            margin-bottom: 10px;
        }

        .function-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .session-date-input {
            position: relative;
        }

        .session-date-input input {
            cursor: pointer;
        }

        .session-date-input::after {
            content: "";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .assignment-group {
            margin-bottom: 15px;
        }

        .assignment-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* Styl dla nowej strony Usprawiedliwienia */
        .excuse-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .excuse-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .excuse-card-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2a1848;
        }

        .excuse-card-date {
            font-weight: bold;
            color: #5f4bb7;
        }

        .excuse-card-body {
            margin-top: 15px;
        }

        .excuse-select {
            width: 100%;
            height: 150px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .no-future-sessions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: #666;
        }

        /* Nowy styl dla sekcji funkcji w osobach */
        .function-section {
            margin-top: 20px;
        }

        .function-section-title {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #2a1848;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        /* Nowe style dla usprawiedliwie≈Ñ */
        .excuse-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .excuse-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .excuse-card-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2a1848;
        }

        .excuse-card-date {
            font-weight: bold;
            color: #5f4bb7;
        }

        .excuse-card-body {
            margin-top: 15px;
        }

        .excuse-select {
            width: 100%;
            height: 150px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .no-future-sessions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: #666;
        }

        .no-groups {
            color: #dc3545;
            font-weight: bold;
        }

        .person-meta div {
            margin-bottom: 5px;
        }

        /* Nowe style dla listy os√≥b do usprawiedliwienia */
        .excuse-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .excuse-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .excuse-item:last-child {
            border-bottom: none;
        }

        .excuse-item input {
            margin-right: 10px;
            width: auto;
        }

        .select-all-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .auth-btn {
          background-color: #4285F4;
          color: white;
          border: none;
          padding: 10px 15px;
          border-radius: 5px;
          cursor: pointer;
          display: inline-block;
          font-size: 14px;
          transition: background-color 0.3s;
        }
        
        .auth-btn:hover {
          background-color: #3367D6;
        }
        
    </style>
</head>

<body>
    <header>
        <h1>System sprawdzania obecno≈õci</h1>
    </header>

    <div class="container">
        <nav>
            <h2>Menu</h2>
            <a href="#" class="nav-link active" data-page="lists">Listy obecno≈õci</a>
            <a href="#" class="nav-link" data-page="new-list">Nowa lista</a>
            <a href="#" class="nav-link" data-page="global-people">Dodawanie os√≥b</a>
            <a href="#" class="nav-link" data-page="functions">Funkcje</a>
            <a href="#" class="nav-link" data-page="people">Osoby</a>
            <a href="#" class="nav-link" data-page="excuses">Usprawiedliwienia</a>
            <a href="#" class="nav-link" data-page="stats">Statystyki obecno≈õci</a>
        </nav>

        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
          <h2>Autoryzacja Firebase</h2>
          <div id="firebase-auth-container" style="margin-top: 10px;">
            <div id="auth-status" style="margin-bottom: 10px;">Nieautoryzowany</div>
            <button id="sign-in-btn" class="auth-btn">Zaloguj z Google</button>
            <button id="sign-out-btn" class="auth-btn" style="display: none;">Wyloguj</button>
          </div>
        </div>
        
        <main>
            <!-- Strona: Listy obecno≈õci -->
            <div id="lists" class="page active">
                <h2>Twoje listy obecno≈õci</h2>
                <div id="list-container"></div>
            </div>

            <!-- Strona: Nowa lista -->
            <div id="new-list" class="page">
                <h2>Utw√≥rz nowƒÖ listƒô</h2>
                <div>
                    <label for="list-name">Nazwa listy:</label>
                    <input type="text" id="list-name" placeholder="Np. Grupa A, Klasa 3B">
                    <button id="create-list">Utw√≥rz listƒô</button>
                </div>
            </div>

            <!-- Strona: Dodawanie os√≥b globalnych -->
            <div id="global-people" class="page">
                <h2>Dodawanie os√≥b globalnych</h2>
                <div>
                    <label for="new-global-person">Imiƒô i nazwisko:</label>
                    <input type="text" id="new-global-person" placeholder="Imiƒô i nazwisko">
                    <button id="add-global-person">Dodaj osobƒô</button>
                </div>
                <div>
                    <h3>Lista os√≥b globalnych</h3>
                    <ul id="global-people-list"></ul>
                </div>
            </div>

            <!-- Strona: Funkcje -->
            <div id="functions" class="page">
                <h2>ZarzƒÖdzanie funkcjami</h2>
                <div>
                    <label for="new-function">Nazwa funkcji:</label>
                    <input type="text" id="new-function" placeholder="Np. Kierownik, Koordynator">
                    <button id="add-function">Dodaj funkcjƒô</button>
                </div>

                <div class="functions-container">
                    <div class="function-card">
                        <h3>Dostƒôpne funkcje</h3>
                        <div id="functions-list"></div>
                    </div>
                </div>
            </div>

            <!-- Strona: Osoby (zaktualizowana) -->
            <div id="people" class="page">
                <h2>Osoby</h2>
                <div id="people-details-container"></div>
            </div>

            <!-- Nowa strona: Usprawiedliwienia -->
            <div id="excuses" class="page">
                <h2>Usprawiedliwienia</h2>
                <div id="future-sessions-container"></div>
            </div>

            <!-- Strona: ZarzƒÖdzanie listƒÖ -->
            <div id="manage-list" class="page">
                <h2 id="current-list-name">ZarzƒÖdzanie listƒÖ</h2>

                <!-- Sekcja sesji na g√≥rze -->
                <div>
                    <h3>Sesje obecno≈õci</h3>
                    <div class="session-date-input">
                        <label for="session-date">Data sesji:</label>
                        <input type="date" id="session-date">
                        <button id="add-session">Dodaj sesjƒô</button>
                    </div>
                    <div id="sessions-container" style="margin-top: 20px;"></div>
                </div>

                <!-- Sekcja dodawania os√≥b -->
                <div>
                    <h3>Dodaj osobƒô do listy</h3>
                    <select id="person-to-add">
                        <option value="">Wybierz osobƒô</option>
                        <!-- Opcje bƒôdƒÖ dodawane dynamicznie -->
                    </select>
                    <button id="add-person-to-list">Dodaj osobƒô do listy</button>
                </div>

                <!-- Sekcja os√≥b na li≈õcie -->
                <div>
                    <h3>Osoby na li≈õcie</h3>
                    <table id="people-list">
                        <thead>
                            <tr>
                                <th>Imiƒô i nazwisko</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody id="people-list-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Strona: Statystyki obecno≈õci -->
            <div id="stats" class="page">
                <h2>Statystyki obecno≈õci</h2>

                <div class="filter-section">
                    <div class="filter-group">
                        <label for="period">Okres:</label>
                        <select id="period">
                            <option value="all">Ca≈Çy okres</option>
                            <option value="1">Ostatni miesiƒÖc</option>
                            <option value="2">Ostatnie 2 miesiƒÖce</option>
                            <option value="3">Ostatnie 3 miesiƒÖce</option>
                            <option value="6">Ostatnie 6 miesiƒôcy</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="list-filter">Lista:</label>
                        <select id="list-filter">
                            <option value="all">Wszystkie listy</option>
                            <!-- Opcje bƒôdƒÖ dodawane dynamicznie -->
                        </select>
                    </div>

                    <button id="apply-filter">Zastosuj filtr</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Osoba</th>
                            <th>Obecno≈õci</th>
                            <th>Nieobecno≈õci</th>
                            <th>Usprawiedliwienia</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="stats-body"></tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // Struktura danych
        let attendanceData = {
            lists: JSON.parse(localStorage.getItem('attendanceLists')) || [],
            globalPeople: JSON.parse(localStorage.getItem('globalPeople')) || [],
            personDetails: JSON.parse(localStorage.getItem('personDetails')) || {},
            functions: JSON.parse(localStorage.getItem('globalFunctions')) || []
        };

        // Stan aplikacji
        let currentState = {
            activeListId: null,
            currentSession: null
        };

        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', () => {
            renderLists();
            renderGlobalPeople();
            renderFunctions();
            setupNavigation();
            setupEventListeners();
            renderListFilterOptions();

            // Dodaj obs≈Çugƒô klawisza Enter
            setupKeyboardShortcuts();

            // Automatycznie otw√≥rz kalendarz przy dodawaniu sesji
            setupSessionDateInput();
        });

        // Renderowanie list
        function renderLists() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';

            if (attendanceData.lists.length === 0) {
                container.innerHTML = '<p>Brak list. Utw√≥rz nowƒÖ listƒô.</p>';
                return;
            }

            attendanceData.lists.forEach(list => {
                const listElement = document.createElement('div');
                listElement.className = 'list-item';
                listElement.dataset.id = list.id;

                const sessionCount = list.sessions ? list.sessions.length : 0;
                const peopleCount = list.people ? list.people.length : 0;

                listElement.innerHTML = `
                    <div>
                        <strong>${list.name}</strong>
                        <div style="font-size: 0.9em; color: #666;">
                            Osoby: ${peopleCount}, Sesje: ${sessionCount}
                        </div>
                    </div>
                    <div>
                        <button data-id="${list.id}" class="delete-list">Usu≈Ñ</button>
                    </div>
                `;
                container.appendChild(listElement);

                // Klikniƒôcie na listƒô otwiera jƒÖ
                listElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-list')) {
                        openList(list.id);
                    }
                });
            });

            // Dodaj obs≈Çugƒô usuwania list
            document.querySelectorAll('.delete-list').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const listId = e.target.dataset.id;
                    deleteList(listId);
                });
            });
        }

        // Renderowanie os√≥b globalnych
        function renderGlobalPeople() {
            const container = document.getElementById('global-people-list');
            container.innerHTML = '';

            if (attendanceData.globalPeople.length === 0) {
                container.innerHTML = '<p>Brak os√≥b. Dodaj nowe osoby.</p>';
                return;
            }

            attendanceData.globalPeople.forEach((person, index) => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.style.marginBottom = '5px';

                li.innerHTML = `
                    <div>${person}</div>
                    <button class="remove-global-person" data-index="${index}">Usu≈Ñ</button>
                `;
                container.appendChild(li);
            });

            // Dodaj obs≈Çugƒô usuwania os√≥b globalnych
            document.querySelectorAll('.remove-global-person').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const person = attendanceData.globalPeople[index];

                    // Usu≈Ñ osobƒô ze wszystkich list
                    attendanceData.lists.forEach(list => {
                        if (list.people) {
                            const personIndex = list.people.indexOf(person);
                            if (personIndex !== -1) {
                                list.people.splice(personIndex, 1);
                            }
                        }
                    });

                    // Usu≈Ñ osobƒô z globalnej listy
                    attendanceData.globalPeople.splice(index, 1);

                    // Usu≈Ñ szczeg√≥≈Çy osoby
                    delete attendanceData.personDetails[person];

                    saveData();
                    renderGlobalPeople();
                    renderListPeopleOptions();
                    renderPeopleDetails();
                    renderLists();
                });
            });
        }

        // Renderowanie funkcji
        function renderFunctions() {
            const container = document.getElementById('functions-list');
            container.innerHTML = '';

            if (attendanceData.functions.length === 0) {
                container.innerHTML = '<p>Brak funkcji. Dodaj nowe funkcje.</p>';
                return;
            }

            attendanceData.functions.forEach((func, index) => {
                const funcElement = document.createElement('div');
                funcElement.className = 'function-item';

                funcElement.innerHTML = `
                    <div>${func}</div>
                    <button class="remove-function" data-index="${index}">Usu≈Ñ</button>
                `;

                container.appendChild(funcElement);
            });

            // Dodaj obs≈Çugƒô usuwania funkcji
            document.querySelectorAll('.remove-function').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const functionName = attendanceData.functions[index];

                    // Usu≈Ñ funkcjƒô ze wszystkich os√≥b
                    for (const person in attendanceData.personDetails) {
                        const details = attendanceData.personDetails[person];
                        if (details.functions) {
                            const funcIndex = details.functions.indexOf(functionName);
                            if (funcIndex !== -1) {
                                details.functions.splice(funcIndex, 1);
                            }
                        }
                    }

                    // Usu≈Ñ funkcjƒô z listy globalnej
                    attendanceData.functions.splice(index, 1);

                    saveData();
                    renderFunctions();
                    renderPeopleDetails();
                });
            });
        }

        // Renderowanie szczeg√≥≈Ç√≥w os√≥b (zaktualizowane)
        function renderPeopleDetails() {
            const container = document.getElementById('people-details-container');
            container.innerHTML = '';

            if (attendanceData.globalPeople.length === 0) {
                container.innerHTML = '<p>Brak os√≥b. Dodaj nowe osoby w zak≈Çadce "Dodawanie os√≥b".</p>';
                return;
            }

            attendanceData.globalPeople.forEach(person => {
                const detailElement = document.createElement('div');
                detailElement.className = 'person-detail-row';

                // Znajd≈∫ listy, w kt√≥rych jest osoba
                const lists = attendanceData.lists.filter(list =>
                    list.people && list.people.includes(person)
                ).map(list => list.name);

                // Funkcje osoby
                const functions = attendanceData.personDetails[person]?.functions || [];

                detailElement.innerHTML = `
                    <div class="person-info">
                        <div class="person-name">${person}</div>
                        <div class="person-meta">
                            <div><strong>Podzespo≈Çy:</strong> ${lists.join(', ') || 'Brak'}</div>
                        </div>
                    </div>
                    
                    <div class="function-section">
                        <div class="function-section-title">Przypisane funkcje</div>
                        <div class="function-list">
                            ${functions.map(func => `
                                <span class="function-tag">
                                    ${func}
                                    <button class="remove-function" data-person="${person}" data-function="${func}">√ó</button>
                                </span>
                            `).join('')}
                        </div>
                        
                        <div class="function-controls">
                            <select class="function-select" data-person="${person}">
                                <option value="">Wybierz funkcjƒô</option>
                                ${attendanceData.functions.map(func => `
                                    <option value="${func}">${func}</option>
                                `).join('')}
                            </select>
                            <button class="assign-function" data-person="${person}">Przypisz funkcjƒô</button>
                        </div>
                    </div>
                `;

                container.appendChild(detailElement);
            });

            // Dodaj obs≈Çugƒô przypisywania funkcji
            document.querySelectorAll('.assign-function').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const person = e.target.dataset.person;
                    const select = document.querySelector(`.function-select[data-person="${person}"]`);
                    const functionName = select.value;

                    if (!functionName) {
                        alert('Proszƒô wybraƒá funkcjƒô');
                        return;
                    }

                    if (!attendanceData.personDetails[person]) {
                        attendanceData.personDetails[person] = { functions: [] };
                    }

                    if (!attendanceData.personDetails[person].functions.includes(functionName)) {
                        attendanceData.personDetails[person].functions.push(functionName);
                        saveData();
                        renderPeopleDetails();
                    }

                    select.value = '';
                });
            });

            // Dodaj obs≈Çugƒô usuwania funkcji
            document.querySelectorAll('.function-tag .remove-function').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const person = e.target.dataset.person;
                    const functionName = e.target.dataset.function;

                    if (attendanceData.personDetails[person] && attendanceData.personDetails[person].functions) {
                        const index = attendanceData.personDetails[person].functions.indexOf(functionName);
                        if (index !== -1) {
                            attendanceData.personDetails[person].functions.splice(index, 1);
                            saveData();
                            renderPeopleDetails();
                        }
                    }
                });
            });
        }

        // Renderowanie opcji dla listy os√≥b w statystykach
        function renderListFilterOptions() {
            const select = document.getElementById('list-filter');
            select.innerHTML = '<option value="all">Wszystkie listy</option>';

            attendanceData.lists.forEach(list => {
                const option = document.createElement('option');
                option.value = list.id;
                option.textContent = list.name;
                select.appendChild(option);
            });
        }

        // Renderowanie opcji dla listy os√≥b w zarzƒÖdzaniu listƒÖ
        function renderListPeopleOptions() {
            const select = document.getElementById('person-to-add');
            select.innerHTML = '<option value="">Wybierz osobƒô</option>';

            attendanceData.globalPeople.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                select.appendChild(option);
            });
        }

        // Obs≈Çuga nawigacji
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.target.dataset.page;

                    // Ukryj wszystkie strony
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });

                    // Usu≈Ñ aktywnƒÖ klasƒô z link√≥w
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                    });

                    // Poka≈º wybranƒÖ stronƒô
                    document.getElementById(pageId).classList.add('active');
                    e.target.classList.add('active');

                    // Od≈õwie≈º zawarto≈õƒá strony
                    if (pageId === 'stats') {
                        renderStats();
                    } else if (pageId === 'global-people') {
                        renderGlobalPeople();
                    } else if (pageId === 'people') {
                        renderPeopleDetails();
                    } else if (pageId === 'lists') {
                        renderLists();
                    } else if (pageId === 'functions') {
                        renderFunctions();
                    } else if (pageId === 'excuses') {
                        renderFutureSessions();
                    }
                });
            });
        }

        // Ustawianie skr√≥t√≥w klawiaturowych
        function setupKeyboardShortcuts() {
            // Enter przy tworzeniu listy
            document.getElementById('list-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('create-list').click();
                }
            });

            // Enter przy dodawaniu osoby globalnej
            document.getElementById('new-global-person').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('add-global-person').click();
                }
            });

            // Enter przy dodawaniu sesji
            document.getElementById('session-date').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('add-session').click();
                }
            });

            // Enter przy dodawaniu osoby do listy
            document.getElementById('person-to-add').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('add-person-to-list').click();
                }
            });

            // Enter przy dodawaniu funkcji
            document.getElementById('new-function').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('add-function').click();
                }
            });
        }

        // Ustawienie kalendarza dla sesji
        function setupSessionDateInput() {
            const dateInput = document.getElementById('session-date');

            // Ustaw dzisiejszƒÖ datƒô jako domy≈õlnƒÖ
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;

            // Automatycznie otw√≥rz kalendarz
            dateInput.focus();
            dateInput.click();
        }

        // Nas≈Çuchiwanie zdarze≈Ñ
        function setupEventListeners() {
            // Tworzenie nowej listy
            document.getElementById('create-list').addEventListener('click', () => {
                const listName = document.getElementById('list-name').value.trim();
                if (!listName) {
                    alert('Proszƒô podaƒá nazwƒô listy');
                    return;
                }

                const newList = {
                    id: Date.now().toString(),
                    name: listName,
                    people: [],
                    sessions: []
                };

                attendanceData.lists.push(newList);
                saveData();
                renderLists();
                renderListFilterOptions();
                document.getElementById('list-name').value = '';
                alert(`Utworzono nowƒÖ listƒô: ${listName}`);
            });

            // Dodawanie osoby globalnej
            document.getElementById('add-global-person').addEventListener('click', () => {
                const name = document.getElementById('new-global-person').value.trim();
                if (!name) {
                    alert('Proszƒô podaƒá imiƒô i nazwisko');
                    return;
                }

                if (attendanceData.globalPeople.includes(name)) {
                    alert('Osoba o tym imieniu i nazwisku ju≈º istnieje!');
                    return;
                }

                attendanceData.globalPeople.push(name);

                // Inicjalizuj szczeg√≥≈Çy osoby
                if (!attendanceData.personDetails[name]) {
                    attendanceData.personDetails[name] = { functions: [] };
                }

                saveData();
                renderGlobalPeople();
                renderListPeopleOptions();
                document.getElementById('new-global-person').value = '';
            });

            // Dodawanie funkcji
            document.getElementById('add-function').addEventListener('click', () => {
                const functionName = document.getElementById('new-function').value.trim();
                if (!functionName) {
                    alert('Proszƒô podaƒá nazwƒô funkcji');
                    return;
                }

                if (attendanceData.functions.includes(functionName)) {
                    alert('Funkcja o tej nazwie ju≈º istnieje!');
                    return;
                }

                attendanceData.functions.push(functionName);
                saveData();
                renderFunctions();
                document.getElementById('new-function').value = '';
            });

            // Dodawanie osoby do listy
            document.getElementById('add-person-to-list').addEventListener('click', () => {
                const person = document.getElementById('person-to-add').value.trim();
                if (!person) {
                    alert('Proszƒô wybraƒá osobƒô');
                    return;
                }

                const list = attendanceData.lists.find(l => l.id === currentState.activeListId);
                if (list) {
                    if (!list.people) list.people = [];

                    if (list.people.includes(person)) {
                        alert('Osoba jest ju≈º na li≈õcie!');
                        return;
                    }

                    list.people.push(person);
                    saveData();
                    renderPeopleList();
                    renderPeopleDetails();
                }
            });

            // Dodawanie sesji
            document.getElementById('add-session').addEventListener('click', () => {
                const date = document.getElementById('session-date').value;
                if (!date) {
                    alert('Proszƒô wybraƒá datƒô sesji');
                    return;
                }

                const list = attendanceData.lists.find(l => l.id === currentState.activeListId);
                if (!list) return;

                // Sprawd≈∫ czy sesja ju≈º istnieje
                if (list.sessions.some(s => s.date === date)) {
                    alert('Sesja dla tej daty ju≈º istnieje!');
                    return;
                }

                const newSession = {
                    date: date,
                    attendance: {}
                };

                // Domy≈õlnie wszyscy obecni
                if (list.people) {
                    list.people.forEach(person => {
                        newSession.attendance[person] = 'present';
                    });
                }

                if (!list.sessions) list.sessions = [];
                list.sessions.push(newSession);
                saveData();
                renderSessions();

                // Automatycznie otw√≥rz kalendarz ponownie
                setupSessionDateInput();
            });

            // Filtrowanie statystyk
            document.getElementById('apply-filter').addEventListener('click', renderStats);
        }

        // Otwieranie listy
        function openList(listId) {
            const list = attendanceData.lists.find(l => l.id === listId);
            if (!list) return;

            currentState.activeListId = listId;
            document.getElementById('current-list-name').textContent = `ZarzƒÖdzanie listƒÖ: ${list.name}`;

            // Prze≈ÇƒÖcz na stronƒô zarzƒÖdzania
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('manage-list').classList.add('active');

            // Aktualizuj menu
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Inicjalizuj puste listy je≈õli nie istniejƒÖ
            if (!list.people) list.people = [];
            if (!list.sessions) list.sessions = [];

            renderListPeopleOptions();
            renderPeopleList();
            renderSessions();
        }

        // Renderowanie listy os√≥b
        function renderPeopleList() {
            const list = attendanceData.lists.find(l => l.id === currentState.activeListId);
            if (!list) return;

            const tbody = document.getElementById('people-list-body');
            tbody.innerHTML = '';

            list.people.forEach((person, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${person}</td>
                    <td>
                        <button class="remove-person" data-index="${index}">Usu≈Ñ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Dodaj obs≈Çugƒô usuwania os√≥b
            document.querySelectorAll('.remove-person').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const person = list.people[index];

                    // Usu≈Ñ osobƒô ze wszystkich sesji
                    list.sessions.forEach(session => {
                        if (session.attendance[person]) {
                            delete session.attendance[person];
                        }
                    });

                    list.people.splice(index, 1);
                    saveData();
                    renderPeopleList();
                    renderSessions();
                    renderPeopleDetails();
                });
            });
        }

        // Otwieranie sesji
        function openSession(sessionIndex) {
            const list = attendanceData.lists.find(l => l.id === currentState.activeListId);
            if (!list || !list.sessions[sessionIndex]) return;

            currentState.currentSession = sessionIndex;
            const session = list.sessions[sessionIndex];

            // Utw√≥rz okno modalne do zarzƒÖdzania sesjƒÖ
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';

            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.width = '90%';
            modalContent.style.maxWidth = '800px';
            modalContent.style.maxHeight = '90vh';
            modalContent.style.overflowY = 'auto';

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Obecno≈õƒá: ${session.date}</h2>
                    <button id="close-modal" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">√ó</button>
                </div>
                <p>Lista: ${list.name}</p>
                
                <table>
                    <thead>
                        <tr>
                            <th>Osoba</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="session-attendance-body"></tbody>
                </table>
                <div style="margin-top: 20px; text-align: right;">
                    <button id="save-session">Zapisz zmiany</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Wype≈Çnij tabelƒô obecno≈õci
            const tbody = document.getElementById('session-attendance-body');
            tbody.innerHTML = '';

            list.people.forEach(person => {
                const row = document.createElement('tr');
                const status = session.attendance[person] || 'present';

                row.innerHTML = `
                    <td>${person}</td>
                    <td>
                        <select class="person-attendance" data-person="${person}">
                            <option value="present" ${status === 'present' ? 'selected' : ''}>Obecny</option>
                            <option value="absent" ${status === 'absent' ? 'selected' : ''}>Nieobecny</option>
                            <option value="excused" ${status === 'excused' ? 'selected' : ''}>Usprawiedliwiony</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Obs≈Çuga zamkniƒôcia modala
            document.getElementById('close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Zapisywanie zmian w sesji
            document.getElementById('save-session').addEventListener('click', () => {
                document.querySelectorAll('.person-attendance').forEach(select => {
                    const person = select.dataset.person;
                    const status = select.value;
                    session.attendance[person] = status;
                });

                saveData();
                alert('Zmiany zosta≈Çy zapisane!');
                document.body.removeChild(modal);
                renderSessions();
            });
        }

        // Renderowanie statystyk
        function renderStats() {
            const tbody = document.getElementById('stats-body');
            tbody.innerHTML = '';

            const period = document.getElementById('period').value;
            const listFilter = document.getElementById('list-filter').value;
            const today = new Date();
            const periodStart = new Date(today);

            if (period === '1') {
                periodStart.setMonth(periodStart.getMonth() - 1);
            } else if (period === '2') {
                periodStart.setMonth(periodStart.getMonth() - 2);
            } else if (period === '3') {
                periodStart.setMonth(periodStart.getMonth() - 3);
            } else if (period === '6') {
                periodStart.setMonth(periodStart.getMonth() - 6);
            }

            const stats = {};

            // Przejd≈∫ przez wszystkie listy i sesje
            attendanceData.lists.forEach(list => {
                // Pomijaj je≈õli filtr jest ustawiony na konkretnƒÖ listƒô
                if (listFilter !== 'all' && list.id !== listFilter) {
                    return;
                }

                if (list.sessions) {
                    list.sessions.forEach(session => {
                        const sessionDate = new Date(session.date);

                        // Je≈õli wybrano okres, sprawd≈∫ czy sesja mie≈õci siƒô w przedziale
                        if (period !== 'all' && sessionDate < periodStart) {
                            return;
                        }

                        if (session.attendance) {
                            Object.entries(session.attendance).forEach(([person, status]) => {
                                // Klucz tylko po imieniu i nazwisku
                                if (!stats[person]) {
                                    stats[person] = {
                                        person: person,
                                        present: 0,
                                        absent: 0,
                                        excused: 0
                                    };
                                }

                                if (status === 'present') {
                                    stats[person].present++;
                                } else if (status === 'absent') {
                                    stats[person].absent++;
                                } else if (status === 'excused') {
                                    stats[person].excused++;
                                }
                            });
                        }
                    });
                }
            });

            // Konwertuj na tablicƒô i sortuj
            const statsArray = Object.values(stats).sort((a, b) => b.absent - a.absent);

            // Wy≈õwietl statystyki
            statsArray.forEach(data => {
                const row = document.createElement('tr');

                // Dodaj ostrze≈ºenie je≈õli nieobecno≈õci >= 3
                const warning = data.absent >= 3 ? '<span class="warning-icon">‚ö†Ô∏è</span>' : '';

                // Okre≈õl klasƒô dla nieobecno≈õci
                const absentClass = data.absent < 3 ? 'absent-badge' : 'absent-high-badge';

                row.innerHTML = `
                    <td>${data.person}</td>
                    <td>
                        <span class="badge-circle present-badge">${data.present}</span>
                    </td>
                    <td>
                        <span class="badge-circle ${absentClass}">${data.absent}</span>
                    </td>
                    <td>
                        <span class="badge-circle excused-badge">${data.excused}</span>
                    </td>
                    <td>${warning}</td>
                `;
                tbody.appendChild(row);
            });

            if (statsArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Brak danych w wybranym okresie</td></tr>';
            }
        }

        // Usuwanie listy
        function deleteList(listId) {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô listƒô?')) return;

            attendanceData.lists = attendanceData.lists.filter(list => list.id !== listId);
            saveData();
            renderLists();
            renderListFilterOptions();
            renderPeopleDetails();
        }

        // Zapisywanie danych
        function saveData() {
            localStorage.setItem('attendanceLists', JSON.stringify(attendanceData.lists));
            localStorage.setItem('globalPeople', JSON.stringify(attendanceData.globalPeople));
            localStorage.setItem('personDetails', JSON.stringify(attendanceData.personDetails));
            localStorage.setItem('globalFunctions', JSON.stringify(attendanceData.functions));
        }

        // Renderowanie przysz≈Çych sesji dla usprawiedliwie≈Ñ
        function renderFutureSessions() {
            const container = document.getElementById('future-sessions-container');
            container.innerHTML = '';

            const today = new Date().toISOString().split('T')[0];
            let hasFutureSessions = false;

            attendanceData.lists.forEach(list => {
                if (list.sessions) {
                    list.sessions.forEach(session => {
                        if (session.date >= today) {
                            hasFutureSessions = true;

                            const excuseCard = document.createElement('div');
                            excuseCard.className = 'excuse-card';

                            excuseCard.innerHTML = `
                                <div class="excuse-card-header">
                                    <div class="excuse-card-title">${list.name}</div>
                                    <div class="excuse-card-date">${session.date}</div>
                                </div>
                                <div class="excuse-card-body">
                                    <label for="excuse-select-${list.id}-${session.date}">Osoby do usprawiedliwienia:</label>
                                    <select class="excuse-select" id="excuse-select-${list.id}-${session.date}" multiple>
                                        ${list.people ? list.people.map(person => {
                                const isExcused = session.attendance[person] === 'excused';
                                return `<option value="${person}" ${isExcused ? 'selected' : ''}>${person}</option>`;
                            }).join('') : ''}
                                    </select>
                                    <button class="save-excuse" data-list="${list.id}" data-date="${session.date}">Zapisz usprawiedliwienia</button>
                                </div>
                            `;

                            container.appendChild(excuseCard);
                        }
                    });
                }
            });

            if (!hasFutureSessions) {
                container.innerHTML = `
                    <div class="no-future-sessions">
                        <p>Brak nadchodzƒÖcych sesji.</p>
                        <p>Dodaj sesje z przysz≈Çymi datami w zak≈Çadce "Listy obecno≈õci".</p>
                    </div>
                `;
            }

            // Dodaj obs≈Çugƒô zapisywania usprawiedliwie≈Ñ
            document.querySelectorAll('.save-excuse').forEach(btn => {
                btn.addEventListener('click', function () {
                    const listId = this.dataset.list;
                    const sessionDate = this.dataset.date;
                    const select = this.previousElementSibling;
                    const selectedPersons = Array.from(select.selectedOptions).map(opt => opt.value);

                    // Znajd≈∫ sesjƒô
                    const list = attendanceData.lists.find(l => l.id === listId);
                    if (!list || !list.sessions) return;

                    const session = list.sessions.find(s => s.date === sessionDate);
                    if (!session) return;

                    // Zaktualizuj status obecno≈õci
                    list.people.forEach(person => {
                        if (selectedPersons.includes(person)) {
                            session.attendance[person] = 'excused';
                        } else if (session.attendance[person] === 'excused') {
                            // Je≈õli osoba by≈Ça usprawiedliwiona, ale teraz nie jest wybrana
                            session.attendance[person] = 'present';
                        }
                    });

                    saveData();
                    alert('Zapisano usprawiedliwienia!');
                });
            });
        }

        // Renderowanie szczeg√≥≈Ç√≥w os√≥b (zaktualizowane)
        function renderPeopleDetails() {
            const container = document.getElementById('people-details-container');
            container.innerHTML = '';

            if (attendanceData.globalPeople.length === 0) {
                container.innerHTML = '<p>Brak os√≥b. Dodaj nowe osoby w zak≈Çadce "Dodawanie os√≥b".</p>';
                return;
            }

            attendanceData.globalPeople.forEach(person => {
                const detailElement = document.createElement('div');
                detailElement.className = 'person-detail-row';

                // Znajd≈∫ listy, w kt√≥rych jest osoba
                const lists = attendanceData.lists.filter(list =>
                    list.people && list.people.includes(person)
                ).map(list => list.name);

                // Funkcje osoby
                const functions = attendanceData.personDetails[person]?.functions || [];

                // Formatowanie wy≈õwietlania list (pod≈õwietlenie "Brak")
                const listsDisplay = lists.length > 0
                    ? lists.join(', ')
                    : '<span class="no-groups">Brak</span>';

                detailElement.innerHTML = `
                    <div class="person-info">
                        <div class="person-name">${person}</div>
                        <div class="person-meta">
                            <div><strong>Podzespo≈Çy:</strong> ${listsDisplay}</div>
                        </div>
                    </div>
                    
                    <div class="function-section">
                        <div class="function-section-title">Przypisane funkcje</div>
                        <div class="function-list">
                            ${functions.map(func => `
                                <span class="function-tag">
                                    ${func}
                                    <button class="remove-function" data-person="${person}" data-function="${func}">√ó</button>
                                </span>
                            `).join('')}
                        </div>
                        
                        <div class="function-controls">
                            <select class="function-select" data-person="${person}">
                                <option value="">Wybierz funkcjƒô</option>
                                ${attendanceData.functions.map(func => `
                                    <option value="${func}">${func}</option>
                                `).join('')}
                            </select>
                            <button class="assign-function" data-person="${person}">Przypisz funkcjƒô</button>
                        </div>
                    </div>
                `;

                container.appendChild(detailElement);
            });

        }

        // Renderowanie sesji (z sortowaniem)
        function renderSessions() {
            const container = document.getElementById('sessions-container');
            container.innerHTML = '';

            const list = attendanceData.lists.find(l => l.id === currentState.activeListId);
            if (!list || !list.sessions) return;

            if (list.sessions.length === 0) {
                container.innerHTML = '<p>Brak sesji. Dodaj nowƒÖ sesjƒô.</p>';
                return;
            }

            // Sortuj sesje malejƒÖco po dacie (najnowsze na g√≥rze)
            list.sessions.sort((a, b) => new Date(b.date) - new Date(a.date));

            list.sessions.forEach((session, index) => {
                const sessionElement = document.createElement('div');
                sessionElement.className = 'session-item';
                sessionElement.dataset.index = index;

                // Oblicz statystyki obecno≈õci
                let presentCount = 0;
                let absentCount = 0;
                let excusedCount = 0;

                if (session.attendance) {
                    Object.values(session.attendance).forEach(status => {
                        if (status === 'present') presentCount++;
                        if (status === 'absent') absentCount++;
                        if (status === 'excused') excusedCount++;
                    });
                }

                sessionElement.innerHTML = `
                    <div>
                        <strong>${session.date}</strong>
                        <div>
                            <span class="attendance-present">Obecni: ${presentCount}</span> | 
                            <span class="attendance-absent">Nieobecni: ${absentCount}</span> |
                            <span class="attendance-excused">Usprawiedliwieni: ${excusedCount}</span>
                        </div>
                    </div>
                    <div>
                        <button class="delete-session" data-index="${index}">Usu≈Ñ</button>
                    </div>
                `;
                container.appendChild(sessionElement);

                // Klikniƒôcie na sesjƒô otwiera zarzƒÖdzanie niƒÖ
                sessionElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-session')) {
                        openSession(index);
                    }
                });
            });

            // Dodaj obs≈Çugƒô usuwania sesji
            document.querySelectorAll('.delete-session').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const sessionIndex = parseInt(e.target.dataset.index);
                    if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô sesjƒô?')) {
                        list.sessions.splice(sessionIndex, 1);
                        saveData();
                        renderSessions();
                    }
                });
            });
        }

        // Renderowanie przysz≈Çych sesji dla usprawiedliwie≈Ñ (zaktualizowane)
        function renderFutureSessions() {
            const container = document.getElementById('future-sessions-container');
            container.innerHTML = '';

            const today = new Date().toISOString().split('T')[0];
            let hasFutureSessions = false;

            attendanceData.lists.forEach(list => {
                if (list.sessions) {
                    list.sessions.forEach(session => {
                        if (session.date >= today) {
                            hasFutureSessions = true;

                            const excuseCard = document.createElement('div');
                            excuseCard.className = 'excuse-card';

                            // Generuj unikalny identyfikator dla kontenera os√≥b
                            const containerId = `excuse-container-${list.id}-${session.date}`;

                            excuseCard.innerHTML = `
                                <div class="excuse-card-header">
                                    <div class="excuse-card-title">${list.name}</div>
                                    <div class="excuse-card-date">${session.date}</div>
                                </div>
                                <div class="excuse-card-body">
                                    <label>Osoby do usprawiedliwienia:</label>
                                    
                                    <div class="select-all-buttons">
                                        <button class="select-all-btn" data-container="${containerId}">Zaznacz wszystkie</button>
                                        <button class="deselect-all-btn" data-container="${containerId}">Odznacz wszystkie</button>
                                    </div>
                                    
                                    <div id="${containerId}" class="excuse-list">
                                        ${list.people ? list.people.map(person => {
                                const isExcused = session.attendance[person] === 'excused';
                                return `
                                                <div class="excuse-item">
                                                    <input type="checkbox" id="excuse-${list.id}-${session.date}-${person}" 
                                                        value="${person}" ${isExcused ? 'checked' : ''}>
                                                    <label for="excuse-${list.id}-${session.date}-${person}">${person}</label>
                                                </div>
                                            `;
                            }).join('') : ''}
                                    </div>
                                    <button class="save-excuse" data-list="${list.id}" data-date="${session.date}">Zapisz usprawiedliwienia</button>
                                </div>
                            `;

                            container.appendChild(excuseCard);
                        }
                    });
                }
            });

            if (!hasFutureSessions) {
                container.innerHTML = `
                    <div class="no-future-sessions">
                        <p>Brak nadchodzƒÖcych sesji.</p>
                        <p>Dodaj sesje z przysz≈Çymi datami w zak≈Çadce "Listy obecno≈õci".</p>
                    </div>
                `;
            }

            // Dodaj obs≈Çugƒô zapisywania usprawiedliwie≈Ñ
            document.querySelectorAll('.save-excuse').forEach(btn => {
                btn.addEventListener('click', function () {
                    const listId = this.dataset.list;
                    const sessionDate = this.dataset.date;

                    // Znajd≈∫ sesjƒô
                    const list = attendanceData.lists.find(l => l.id === listId);
                    if (!list || !list.sessions) return;

                    const session = list.sessions.find(s => s.date === sessionDate);
                    if (!session) return;

                    // Zbierz wszystkie zaznaczone osoby
                    const selectedPersons = [];
                    const checkboxes = document.querySelectorAll(`input[type="checkbox"][value][id^="excuse-${listId}-${sessionDate}"]`);
                    checkboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            selectedPersons.push(checkbox.value);
                        }
                    });

                    // Zaktualizuj status obecno≈õci
                    list.people.forEach(person => {
                        if (selectedPersons.includes(person)) {
                            session.attendance[person] = 'excused';
                        } else if (session.attendance[person] === 'excused') {
                            // Je≈õli osoba by≈Ça usprawiedliwiona, ale teraz nie jest wybrana
                            session.attendance[person] = 'present';
                        }
                    });

                    saveData();
                    alert('Zapisano usprawiedliwienia!');
                });
            });

            // Dodaj obs≈Çugƒô przycisk√≥w "Zaznacz wszystkie" i "Odznacz wszystkie"
            document.querySelectorAll('.select-all-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const containerId = this.dataset.container;
                    const container = document.getElementById(containerId);
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                });
            });

            document.querySelectorAll('.deselect-all-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const containerId = this.dataset.container;
                    const container = document.getElementById(containerId);
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                });
            });
        }
        
        // =============================================
        // EKSPORT I IMPORT DANYCH (SYNCHRONIZACJA)
        // =============================================
        
        // Dodanie pozycji w menu
        const navMenu = document.querySelector('nav');
        const syncMenuItem = `
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h2>Synchronizacja</h2>
                <a href="#" class="nav-link" data-page="export-import">Eksport/Import</a>
            </div>
        `;
        navMenu.insertAdjacentHTML('beforeend', syncMenuItem);
        
        // Dodanie strony eksportu/importu
        const mainElement = document.querySelector('main');
        const exportImportPage = `
            <div id="export-import" class="page">
                <h2>Eksport i import danych</h2>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Eksport danych</h3>
                        <p>Eksportuj wszystkie dane do pliku JSON. Mo≈ºesz go zapisaƒá i zaimportowaƒá na innym urzƒÖdzeniu.</p>
                        <button id="export-data" style="margin-top: 15px;">Eksportuj dane</button>
                        <div id="export-result" style="margin-top: 15px; word-break: break-all;"></div>
                    </div>
                    
                    <div style="flex: 1; min-width: 300px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Import danych</h3>
                        <p>Zaimportuj dane z pliku JSON (zastƒÖpiƒÖ one obecne dane w przeglƒÖdarce).</p>
                        <input type="file" id="import-file" accept=".json" style="margin: 15px 0;">
                        <button id="import-data">Importuj dane</button>
                        <div id="import-result" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        `;
        mainElement.insertAdjacentHTML('beforeend', exportImportPage);
        
        // Funkcja eksportu danych
        document.getElementById('export-data')?.addEventListener('click', () => {
            const dataToExport = {
                lists: JSON.parse(localStorage.getItem('attendanceLists')) || [],
                globalPeople: JSON.parse(localStorage.getItem('globalPeople')) || [],
                personDetails: JSON.parse(localStorage.getItem('personDetails')) || {},
                functions: JSON.parse(localStorage.getItem('globalFunctions')) || [],
                version: 1.0,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const exportResult = document.getElementById('export-result');
            
            // Tworzenie pliku do pobrania
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_data_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Pokazanie danych na ekranie
            exportResult.innerHTML = `
                <p style="color: green;">Dane wyeksportowane pomy≈õlnie!</p>
                <details style="margin-top: 10px;">
                    <summary>Poka≈º dane</summary>
                    <pre style="background: white; padding: 10px; border-radius: 5px; max-height: 200px; overflow: auto;">${dataStr}</pre>
                </details>
            `;
        });
        
        // Funkcja importu danych
        document.getElementById('import-data')?.addEventListener('click', () => {
            const fileInput = document.getElementById('import-file');
            const importResult = document.getElementById('import-result');
            
            if (!fileInput.files.length) {
                importResult.innerHTML = '<p style="color: red;">Wybierz plik do importu!</p>';
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Walidacja danych
                    if (!importedData.lists || !importedData.globalPeople || !importedData.personDetails || !importedData.functions) {
                        throw new Error('Nieprawid≈Çowy format pliku');
                    }
                    
                    if (!confirm('Czy na pewno chcesz zaimportowaƒá dane? Wszystkie bie≈ºƒÖce dane zostanƒÖ nadpisane.')) {
                        importResult.innerHTML = '<p style="color: orange;">Import anulowany</p>';
                        return;
                    }
                    
                    // Zapis danych
                    localStorage.setItem('attendanceLists', JSON.stringify(importedData.lists));
                    localStorage.setItem('globalPeople', JSON.stringify(importedData.globalPeople));
                    localStorage.setItem('personDetails', JSON.stringify(importedData.personDetails));
                    localStorage.setItem('globalFunctions', JSON.stringify(importedData.functions));
                    
                    // Aktualizacja stanu aplikacji
                    attendanceData = {
                        lists: importedData.lists,
                        globalPeople: importedData.globalPeople,
                        personDetails: importedData.personDetails,
                        functions: importedData.functions
                    };
                    
                    // Od≈õwie≈ºenie UI
                    renderLists();
                    renderGlobalPeople();
                    renderFunctions();
                    renderListFilterOptions();
                    renderListPeopleOptions();
                    renderPeopleDetails();
                    
                    importResult.innerHTML = `
                        <p style="color: green;">Dane zaimportowane pomy≈õlnie!</p>
                        <p>Zaimportowano:
                            <br>‚Ä¢ Listy: ${importedData.lists.length}
                            <br>‚Ä¢ Osoby: ${importedData.globalPeople.length}
                            <br>‚Ä¢ Funkcje: ${importedData.functions.length}
                        </p>
                    `;
                    
                    // Automatyczne przej≈õcie do list
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    document.getElementById('lists').classList.add('active');
                    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                    document.querySelector(`.nav-link[data-page="lists"]`).classList.add('active');
                    
                } catch (error) {
                    console.error('B≈ÇƒÖd importu:', error);
                    importResult.innerHTML = `<p style="color: red;">B≈ÇƒÖd importu: ${error.message}</p>`;
                }
            };
            
            reader.readAsText(file);
        });
        
        // Aktualizacja funkcji setupNavigation o nowƒÖ stronƒô
        const originalSetupNavigation = setupNavigation;
        setupNavigation = function() {
            originalSetupNavigation();
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    if (e.target.dataset.page === 'export-import') {
                        // Resetuj wyniki
                        document.getElementById('export-result').innerHTML = '';
                        document.getElementById('import-result').innerHTML = '';
                    }
                });
            });
        };
        
        // Ponowne wywo≈Çanie setupNavigation po aktualizacji
        setupNavigation();

        // Konfiguracja Firebase - zastƒÖp tymi warto≈õciami z konsoli
        const firebaseConfig = {
          apiKey: "AIzaSyBi1f47qdude_3zl8vziTlFhVH0xx3J04U",
          authDomain: "projekt-1-974cc.firebaseapp.com",
          projectId: "projekt-1-974cc",
          storageBucket: "projekt-1-974cc.firebasestorage.app",
          messagingSenderId: "537046472561",
          appId: "1:537046472561:web:bd17ffd942f6500a52c8d0",
          measurementId: "G-BJN98JBYJK"
        };
        
        // Inicjalizacja Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Referencje do us≈Çug Firebase
        const auth = firebase.auth();
        const database = firebase.database();
        const provider = new firebase.auth.GoogleAuthProvider();
        
        // Globalna referencja do bazy danych
        let dbRef = null;
        
        // Funkcja logowania
        function signIn() {
          auth.signInWithPopup(provider)
            .then((result) => {
              const user = result.user;
              console.log("Zalogowano jako:", user.email);
              initDatabase(user);
            })
            .catch((error) => {
              console.error("B≈ÇƒÖd logowania:", error);
            });
        }
        
        // Funkcja wylogowywania
        function signOut() {
          auth.signOut()
            .then(() => {
              console.log("Wylogowano");
              dbRef = null;
            })
            .catch((error) => {
              console.error("B≈ÇƒÖd wylogowywania:", error);
            });
        }
        
        // Inicjalizacja bazy danych dla u≈ºytkownika
        function initDatabase(user) {
          dbRef = database.ref(`users/${user.uid}/attendanceSystem`);
          
          // Nas≈Çuchuj zmian w bazie danych
          dbRef.on('value', (snapshot) => {
            const remoteData = snapshot.val();
            if (remoteData) {
              processRemoteData(remoteData);
            }
          });
          
          // Pierwsza synchronizacja
          syncData();
        }
        
        // Przetwarzanie danych z Firebase
        function processRemoteData(remoteData) {
          const localLastUpdated = localStorage.getItem('lastUpdated') || 0;
          
          if (remoteData.lastUpdated > localLastUpdated) {
            // Aktualizuj dane lokalne
            attendanceData = {
              lists: remoteData.lists || [],
              globalPeople: remoteData.globalPeople || [],
              personDetails: remoteData.personDetails || {},
              functions: remoteData.functions || []
            };
            
            // Zapisz w localStorage
            saveLocalData();
            
            // Od≈õwie≈º UI
            renderAll();
          }
        }
        
        // Synchronizacja danych z Firebase
        function syncData() {
          const dataToSave = {
            lists: attendanceData.lists,
            globalPeople: attendanceData.globalPeople,
            personDetails: attendanceData.personDetails,
            functions: attendanceData.functions,
            lastUpdated: firebase.database.ServerValue.TIMESTAMP
          };
          
          if (dbRef) {
            dbRef.set(dataToSave)
              .then(() => console.log("Dane zsynchronizowane z Firebase"))
              .catch(error => console.error("B≈ÇƒÖd synchronizacji:", error));
          }
        }
        
        // Modyfikacja funkcji saveData()
        function saveData() {
          // ... istniejƒÖca logika zapisu do localStorage ...
          
          // Dodaj synchronizacjƒô z Firebase
          syncData();
        }
        
        // Funkcja renderujƒÖca stan uwierzytelniania
        function renderAuthState(user) {
          const authStatus = document.getElementById('auth-status');
          const signInBtn = document.getElementById('sign-in-btn');
          const signOutBtn = document.getElementById('sign-out-btn');
          
          if (user) {
            authStatus.innerHTML = `Zalogowany jako: <strong>${user.email}</strong>`;
            signInBtn.style.display = 'none';
            signOutBtn.style.display = 'block';
          } else {
            authStatus.innerHTML = "Nieautoryzowany";
            signInBtn.style.display = 'block';
            signOutBtn.style.display = 'none';
          }
        }
        
        // Inicjalizacja po za≈Çadowaniu strony
        document.addEventListener('DOMContentLoaded', () => {
          // Inicjalizacja stanu uwierzytelniania
          auth.onAuthStateChanged((user) => {
            renderAuthState(user);
            if (user) {
              initDatabase(user);
            }
          });
        
          // Nas≈Çuchiwanie przycisk√≥w
          document.getElementById('sign-in-btn').addEventListener('click', signIn);
          document.getElementById('sign-out-btn').addEventListener('click', signOut);
          
          // ... reszta istniejƒÖcej inicjalizacji ...
        });

        // =============================================
        // POPRAWIONA KONFIGURACJA FIREBASE
        // =============================================
        
        // Przenie≈õ konfiguracjƒô na poczƒÖtek sekcji Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBi1f47qdude_3zl8vziTlFhVH0xx3J04U",
            authDomain: "projekt-1-974cc.firebaseapp.com",
            projectId: "projekt-1-974cc",
            storageBucket: "projekt-1-974cc.firebasestorage.app",
            messagingSenderId: "537046472561",
            appId: "1:537046472561:web:bd17ffd942f6500a52c8d0",
            measurementId: "G-BJN98JBYJK",
            databaseURL: "https://projekt-1-974cc-default-rtdb.europe-west1.firebasedatabase.app" // DODAJ Tƒò LINIƒò!
        };
        
        // Inicjalizuj Firebase przed u≈ºyciem jakichkolwiek us≈Çug
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase zainicjalizowany poprawnie");
        } catch (error) {
            console.error("B≈ÇƒÖd inicjalizacji Firebase:", error);
        }
        
        // U≈ºyj jednej instancji dla ca≈Çej aplikacji
        const firebaseAuth = firebase.auth();
        const firebaseDatabase = firebase.database();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        
        // Usu≈Ñ ponowne deklaracje (te linie usu≈Ñ ca≈Çkowicie):
        // const auth = firebase.auth();
        // const database = firebase.database();
        // const provider = new firebase.auth.GoogleAuthProvider();
        
        // =============================================
        // POPRAWIONE FUNKCJE LOGOWANIA
        // =============================================
        
        function signIn() {
            firebaseAuth.signInWithPopup(googleProvider)
                .then((result) => {
                    const user = result.user;
                    console.log("Zalogowano jako:", user.email);
                    document.getElementById('auth-status').innerHTML = 
                        `Zalogowany jako: <strong>${user.email}</strong>`;
                    initDatabase(user);
                })
                .catch((error) => {
                    console.error("B≈ÇƒÖd logowania:", error);
                    alert(`B≈ÇƒÖd logowania: ${error.message}`);
                });
        }
        
        function signOut() {
            firebaseAuth.signOut()
                .then(() => {
                    console.log("Wylogowano");
                    document.getElementById('auth-status').textContent = "Nieautoryzowany";
                })
                .catch((error) => {
                    console.error("B≈ÇƒÖd wylogowywania:", error);
                });
        }
        
        // =============================================
        // POPRAWIONA OBS≈ÅUGA STANU UWIERZYTELNIANIA
        // =============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Elementy UI
            const signInBtn = document.getElementById('sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');
            
            if (signInBtn) {
                signInBtn.addEventListener('click', signIn);
            }
            
            if (signOutBtn) {
                signOutBtn.addEventListener('click', signOut);
            }
        
            // Monitorowanie stanu uwierzytelniania
            firebaseAuth.onAuthStateChanged((user) => {
                if (user) {
                    console.log("U≈ºytkownik zalogowany:", user.email);
                    document.getElementById('auth-status').innerHTML = 
                        `Zalogowany jako: <strong>${user.email}</strong>`;
                    document.getElementById('sign-in-btn').style.display = 'none';
                    document.getElementById('sign-out-btn').style.display = 'block';
                    initDatabase(user);
                } else {
                    console.log("Brak zalogowanego u≈ºytkownika");
                    document.getElementById('auth-status').textContent = "Nieautoryzowany";
                    document.getElementById('sign-in-btn').style.display = 'block';
                    document.getElementById('sign-out-btn').style.display = 'none';
                }
            });
            
            // ... reszta istniejƒÖcej inicjalizacji ...
        });
        
        // =============================================
        // POPRAWIONE PO≈ÅƒÑCZENIE Z BAZƒÑ DANYCH
        // =============================================
        
        function initDatabase(user) {
            if (!user) return;
            
            const dbRef = firebaseDatabase.ref(`users/${user.uid}/attendanceSystem`);
            
            // Nas≈Çuchuj zmian w bazie danych
            dbRef.on('value', (snapshot) => {
                const remoteData = snapshot.val();
                if (remoteData) {
                    console.log("Otrzymano dane z Firebase");
                    processRemoteData(remoteData);
                }
            });
            
            // Wykonaj poczƒÖtkowƒÖ synchronizacjƒô
            syncData();
        }
        
        // =============================================
        // DODATKOWE POPRAWKI
        // =============================================
        
        // W funkcji saveData dodaj zapis timestampa:
        function saveData() {
            // ... istniejƒÖca logika ...
            localStorage.setItem('lastUpdated', Date.now());
            
            // Synchronizuj z Firebase
            syncData();
        }
        
        // W funkcji processRemoteData dodaj:
        function processRemoteData(remoteData) {
            const localLastUpdated = localStorage.getItem('lastUpdated') || 0;
            
            if (remoteData.lastUpdated > localLastUpdated) {
                console.log("Aktualizujƒô dane z Firebase");
                // ... reszta kodu ...
            }
        }
    </script>
</body>

</html>
