<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System sprawdzania obecności</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: #d0d1d4;
            color: #333;
        }

        header {
            background: linear-gradient(135deg, #714bb7, #2a1848);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .container {
            display: flex;
            min-height: 80vh;
            gap: 20px;
        }

        nav {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        main {
            flex: 3;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h1, h2, h3 {
            margin-top: 0;
        }

        button {
            background-color: #5f4bb7;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #613a9f;
        }

        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            margin: 5px 0 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #f1f5f9;
        }

        .attendance-present {
            color: #28a745;
        }

        .attendance-absent {
            color: #dc3545;
        }

        .attendance-excused {
            color: #ffc107;
        }

        .attendance-not-taken {
            color: #6c757d;
        }

        .nav-link {
            display: block;
            padding: 10px;
            text-decoration: none;
            color: #333;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            background-color: #eef2f7;
            color: #624bb7;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item:hover {
            background-color: #e9ecef;
        }

        .session-item {
            padding: 8px;
            background-color: #eef2f7;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .session-item:hover {
            background-color: #e2e6ea;
        }

        .badge-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-weight: bold;
            color: white;
        }

        .present-badge {
            background-color: #28a745;
        }

        .absent-badge {
            background-color: #dc3545;
        }

        .excused-badge {
            background-color: #ffc107;
        }

        .person-detail-row {
            background-color: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .function-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e9ecef;
            padding: 6px 12px;
            border-radius: 20px;
            margin: 5px 5px 5px 0;
            font-size: 0.9em;
            gap: 5px;
        }

        .excuse-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .auth-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .auth-btn:hover {
            background-color: #3367D6;
        }
        
        .connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
            background-color: #4CAF50;
            color: white;
        }
        
        .no-groups {
            color: #dc3545;
            font-weight: bold;
        }
        
        .sync-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div id="connection-status" class="connection-status">Online</div>
    <header>
        <h1>System sprawdzania obecności</h1>
    </header>

    <div class="container">
        <nav>
            <h2>Menu</h2>
            <a href="#" class="nav-link active" data-page="lists">Listy obecności</a>
            <a href="#" class="nav-link" data-page="new-list">Nowa lista</a>
            <a href="#" class="nav-link" data-page="global-people">Dodawanie osób</a>
            <a href="#" class="nav-link" data-page="functions">Funkcje</a>
            <a href="#" class="nav-link" data-page="people">Osoby</a>
            <a href="#" class="nav-link" data-page="excuses">Usprawiedliwienia</a>
            <a href="#" class="nav-link" data-page="stats">Statystyki obecności</a>
            <a href="#" class="nav-link" data-page="export-import">Eksport/Import</a>
            
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h2>Autoryzacja</h2>
                <div id="firebase-auth-container" style="margin-top: 10px;">
                    <div id="auth-status" style="margin-bottom: 10px;">Nieautoryzowany</div>
                    <button id="sign-in-btn" class="auth-btn">Zaloguj z Google</button>
                    <button id="sign-out-btn" class="auth-btn" style="display: none;">Wyloguj</button>
                    
                    <div id="sync-buttons" class="sync-buttons" style="display: none;">
                        <button id="save-data-btn" class="auth-btn">Zapisz dane</button>
                        <button id="load-data-btn" class="auth-btn">Wczytaj dane</button>
                    </div>
                </div>
            </div>
        </nav>

        <main>
            <!-- Strona: Listy obecności -->
            <div id="lists" class="page active">
                <h2>Twoje listy obecności</h2>
                <div id="list-container"></div>
            </div>

            <!-- Strona: Nowa lista -->
            <div id="new-list" class="page">
                <h2>Utwórz nową listę</h2>
                <div>
                    <label for="list-name">Nazwa listy:</label>
                    <input type="text" id="list-name" placeholder="Np. Grupa A, Klasa 3B">
                    <button id="create-list">Utwórz listę</button>
                </div>
            </div>

            <!-- Strona: Dodawanie osób globalnych -->
            <div id="global-people" class="page">
                <h2>Dodawanie osób globalnych</h2>
                <div>
                    <label for="new-global-person">Imię i nazwisko:</label>
                    <input type="text" id="new-global-person" placeholder="Imię i nazwisko">
                    <button id="add-global-person">Dodaj osobę</button>
                </div>
                <div>
                    <h3>Lista osób globalnych</h3>
                    <ul id="global-people-list"></ul>
                </div>
            </div>

            <!-- Strona: Funkcje -->
            <div id="functions" class="page">
                <h2>Zarządzanie funkcjami</h2>
                <div>
                    <label for="new-function">Nazwa funkcji:</label>
                    <input type="text" id="new-function" placeholder="Np. Kierownik, Koordynator">
                    <button id="add-function">Dodaj funkcję</button>
                </div>

                <div class="functions-container">
                    <div class="function-card">
                        <h3>Dostępne funkcje</h3>
                        <div id="functions-list"></div>
                    </div>
                </div>
            </div>

            <!-- Strona: Osoby -->
            <div id="people" class="page">
                <h2>Osoby</h2>
                <div id="people-details-container"></div>
            </div>

            <!-- Strona: Usprawiedliwienia -->
            <div id="excuses" class="page">
                <h2>Usprawiedliwienia</h2>
                <div id="future-sessions-container"></div>
            </div>

            <!-- Strona: Zarządzanie listą -->
            <div id="manage-list" class="page">
                <h2 id="current-list-name">Zarządzanie listą</h2>
                <div>
                    <h3>Sesje obecności</h3>
                    <div class="session-date-input">
                        <label for="session-date">Data sesji:</label>
                        <input type="date" id="session-date">
                        <button id="add-session">Dodaj sesję</button>
                    </div>
                    <div id="sessions-container" style="margin-top: 20px;"></div>
                </div>
                <div>
                    <h3>Dodaj osobę do listy</h3>
                    <select id="person-to-add">
                        <option value="">Wybierz osobę</option>
                    </select>
                    <button id="add-person-to-list">Dodaj osobę do listy</button>
                </div>
                <div>
                    <h3>Osoby na liście</h3>
                    <table id="people-list">
                        <thead>
                            <tr>
                                <th>Imię i nazwisko</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody id="people-list-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Strona: Statystyki obecności -->
            <div id="stats" class="page">
                <h2>Statystyki obecności</h2>
                <div class="filter-section">
                    <div class="filter-group">
                        <label for="period">Okres:</label>
                        <select id="period">
                            <option value="all">Cały okres</option>
                            <option value="1">Ostatni miesiąc</option>
                            <option value="2">Ostatnie 2 miesiące</option>
                            <option value="3">Ostatnie 3 miesiące</option>
                            <option value="6">Ostatnie 6 miesięcy</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="list-filter">Lista:</label>
                        <select id="list-filter">
                            <option value="all">Wszystkie listy</option>
                        </select>
                    </div>
                    <button id="apply-filter">Zastosuj filtr</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Osoba</th>
                            <th>Obecności</th>
                            <th>Nieobecności</th>
                            <th>Usprawiedliwienia</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="stats-body"></tbody>
                </table>
            </div>

            <!-- Strona: Eksport/Import -->
            <div id="export-import" class="page">
                <h2>Eksport i import danych</h2>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Eksport danych</h3>
                        <p>Eksportuj wszystkie dane do pliku JSON.</p>
                        <button id="export-data" style="margin-top: 15px;">Eksportuj dane</button>
                        <div id="export-result" style="margin-top: 15px;"></div>
                    </div>
                    <div style="flex: 1; min-width: 300px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3>Import danych</h3>
                        <p>Zaimportuj dane z pliku JSON.</p>
                        <input type="file" id="import-file" accept=".json" style="margin: 15px 0;">
                        <button id="import-data">Importuj dane</button>
                        <div id="import-result" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // =============================================
        // KONFIGURACJA FIREBASE
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBi1f47qdude_3zl8vziTlFhVH0xx3J04U",
            authDomain: "projekt-1-974cc.firebaseapp.com",
            databaseURL: "https://projekt-1-974cc-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "projekt-1-974cc",
            storageBucket: "projekt-1-974cc.appspot.com",
            messagingSenderId: "537046472561",
            appId: "1:537046472561:web:bd17ffd942f6500a52c8d0",
            measurementId: "G-BJN98JBYJK"
        };

        // Inicjalizacja Firebase
        firebase.initializeApp(firebaseConfig);
        const firebaseAuth = firebase.auth();
        const firebaseDatabase = firebase.database();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // =============================================
        // STAN APLIKACJI I DANE
        // =============================================
        let attendanceData = {
            lists: JSON.parse(localStorage.getItem('attendanceLists')) || [],
            globalPeople: JSON.parse(localStorage.getItem('globalPeople')) || [],
            personDetails: JSON.parse(localStorage.getItem('personDetails')) || {},
            functions: JSON.parse(localStorage.getItem('globalFunctions')) || []
        };

        let currentState = {
            activeListId: null,
            currentSession: null
        };

        let dbRef = null;

        // =============================================
        // OBSŁUGA FIREBASE AUTH
        // =============================================
        function signIn() {
            firebaseAuth.signInWithPopup(googleProvider)
                .then((result) => {
                    const user = result.user;
                    console.log("Zalogowano jako:", user.email);
                    initDatabase(user);
                })
                .catch((error) => {
                    console.error("Błąd logowania:", error);
                    alert(`Błąd logowania: ${error.message}`);
                });
        }

        function signOut() {
            firebaseAuth.signOut()
                .then(() => {
                    console.log("Wylogowano");
                    dbRef = null;
                })
                .catch((error) => {
                    console.error("Błąd wylogowywania:", error);
                });
        }

        firebaseAuth.onAuthStateChanged((user) => {
            const authStatus = document.getElementById('auth-status');
            const signInBtn = document.getElementById('sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');
            const syncButtons = document.getElementById('sync-buttons');
            
            if (user) {
                authStatus.innerHTML = `Zalogowany jako: <strong>${user.email}</strong>`;
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'block';
                syncButtons.style.display = 'flex';
                initDatabase(user);
            } else {
                authStatus.textContent = "Nieautoryzowany";
                signInBtn.style.display = 'block';
                signOutBtn.style.display = 'none';
                syncButtons.style.display = 'none';
            }
        });

        // =============================================
        // SYNCHRONIZACJA Z FIREBASE
        // =============================================
        function initDatabase(user) {
            if (!user) return;
            
            dbRef = firebaseDatabase.ref(`users/${user.uid}/attendanceSystem`);
            
            // Nasłuchuj zmian w bazie danych
            dbRef.on('value', (snapshot) => {
                const remoteData = snapshot.val();
                if (remoteData) {
                    processRemoteData(remoteData);
                }
            });
        }

        function processRemoteData(remoteData) {
            const localLastUpdated = localStorage.getItem('lastUpdated') || 0;
            
            if (remoteData.lastUpdated > localLastUpdated) {
                console.log("Aktualizuję dane z Firebase");
                attendanceData = {
                    lists: remoteData.lists || [],
                    globalPeople: remoteData.globalPeople || [],
                    personDetails: remoteData.personDetails || {},
                    functions: remoteData.functions || []
                };
                
                saveLocalData();
                renderAll();
            }
        }

        function saveToFirebase() {
            if (!dbRef) {
                alert("Nie jesteś zalogowany! Zaloguj się, aby zapisać dane.");
                return;
            }
            
            const dataToSave = {
                lists: attendanceData.lists,
                globalPeople: attendanceData.globalPeople,
                personDetails: attendanceData.personDetails,
                functions: attendanceData.functions,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            };
            
            dbRef.set(dataToSave)
                .then(() => {
                    console.log("Dane zapisane w Firebase");
                    alert("Dane zostały zapisane w chmurze!");
                })
                .catch(error => console.error("Błąd zapisu:", error));
        }

        function loadFromFirebase() {
            if (!dbRef) {
                alert("Nie jesteś zalogowany! Zaloguj się, aby wczytać dane.");
                return;
            }
            
            dbRef.once('value').then(snapshot => {
                const remoteData = snapshot.val();
                if (remoteData) {
                    attendanceData = {
                        lists: remoteData.lists || [],
                        globalPeople: remoteData.globalPeople || [],
                        personDetails: remoteData.personDetails || {},
                        functions: remoteData.functions || []
                    };
                    
                    saveLocalData();
                    renderAll();
                    alert("Dane zostały wczytane z chmury!");
                } else {
                    alert("Brak danych do wczytania w chmurze!");
                }
            }).catch(error => {
                console.error("Błąd wczytywania:", error);
                alert("Błąd wczytywania danych: " + error.message);
            });
        }

        // =============================================
        // FUNKCJE POMOCNICZE
        // =============================================
        function saveLocalData() {
            localStorage.setItem('attendanceLists', JSON.stringify(attendanceData.lists));
            localStorage.setItem('globalPeople', JSON.stringify(attendanceData.globalPeople));
            localStorage.setItem('personDetails', JSON.stringify(attendanceData.personDetails));
            localStorage.setItem('globalFunctions', JSON.stringify(attendanceData.functions));
            localStorage.setItem('lastUpdated', Date.now());
        }

        function saveData() {
            saveLocalData();
            if (dbRef) {
                saveToFirebase();
            }
        }

        function renderAll() {
            renderLists();
            renderGlobalPeople();
            renderFunctions();
            renderListFilterOptions();
            renderListPeopleOptions();
            renderPeopleDetails();
            
            if (document.getElementById('manage-list').classList.contains('active')) {
                renderSessions();
                renderPeopleList();
            }
            
            if (document.getElementById('stats').classList.contains('active')) {
                renderStats();
            }
            
            if (document.getElementById('excuses').classList.contains('active')) {
                renderFutureSessions();
            }
        }

        // =============================================
        // IMPLEMENTACJA FUNKCJI APLIKACJI
        // =============================================
        function renderLists() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';

            if (attendanceData.lists.length === 0) {
                container.innerHTML = '<p>Brak list. Utwórz nową listę.</p>';
                return;
            }

            attendanceData.lists.forEach(list => {
                const listElement = document.createElement('div');
                listElement.className = 'list-item';
                listElement.dataset.id = list.id;

                const sessionCount = list.sessions ? list.sessions.length : 0;
                const peopleCount = list.people ? list.people.length : 0;

                listElement.innerHTML = `
                    <div>
                        <strong>${list.name}</strong>
                        <div style="font-size: 0.9em; color: #666;">
                            Osoby: ${peopleCount}, Sesje: ${sessionCount}
                        </div>
                    </div>
                    <div>
                        <button data-id="${list.id}" class="delete-list">Usuń</button>
                    </div>
                `;
                container.appendChild(listElement);

                listElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-list')) {
                        openList(list.id);
                    }
                });
            });

            document.querySelectorAll('.delete-list').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const listId = e.target.dataset.id;
                    deleteList(listId);
                });
            });
        }

        function renderGlobalPeople() {
            const container = document.getElementById('global-people-list');
            container.innerHTML = '';

            if (attendanceData.globalPeople.length === 0) {
                container.innerHTML = '<p>Brak osób. Dodaj nowe osoby.</p>';
                return;
            }

            attendanceData.globalPeople.forEach((person, index) => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.style.marginBottom = '5px';

                li.innerHTML = `
                    <div>${person}</div>
                    <button class="remove-global-person" data-index="${index}">Usuń</button>
                `;
                container.appendChild(li);
            });

            document.querySelectorAll('.remove-global-person').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const person = attendanceData.globalPeople[index];

                    // Usuń osobę ze wszystkich list
                    attendanceData.lists.forEach(list => {
                        if (list.people) {
                            const personIndex = list.people.indexOf(person);
                            if (personIndex !== -1) {
                                list.people.splice(personIndex, 1);
                            }
                        }
                    });

                    // Usuń osobę globalnie
                    attendanceData.globalPeople.splice(index, 1);
                    delete attendanceData.personDetails[person];
                    saveData();
                    renderGlobalPeople();
                    renderListPeopleOptions();
                    renderPeopleDetails();
                    renderLists();
                });
            });
        }

        function renderFunctions() {
            const container = document.getElementById('functions-list');
            container.innerHTML = '';

            if (attendanceData.functions.length === 0) {
                container.innerHTML = '<p>Brak funkcji. Dodaj nowe funkcje.</p>';
                return;
            }

            attendanceData.functions.forEach((func, index) => {
                const funcElement = document.createElement('div');
                funcElement.className = 'function-item';

                funcElement.innerHTML = `
                    <div>${func}</div>
                    <button class="remove-function" data-index="${index}">Usuń</button>
                `;
                container.appendChild(funcElement);
            });

            document.querySelectorAll('.remove-function').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const functionName = attendanceData.functions[index];

                    // Usuń funkcję ze wszystkich osób
                    for (const person in attendanceData.personDetails) {
                        const details = attendanceData.personDetails[person];
                        if (details.functions) {
                            const funcIndex = details.functions.indexOf(functionName);
                            if (funcIndex !== -1) {
                                details.functions.splice(funcIndex, 1);
                            }
                        }
                    }

                    attendanceData.functions.splice(index, 1);
                    saveData();
                    renderFunctions();
                    renderPeopleDetails();
                });
            });
        }

        function renderPeopleDetails() {
            const container = document.getElementById('people-details-container');
            container.innerHTML = '';

            if (attendanceData.globalPeople.length === 0) {
                container.innerHTML = '<p>Brak osób. Dodaj nowe osoby w zakładce "Dodawanie osób".</p>';
                return;
            }

            attendanceData.globalPeople.forEach(person => {
                const detailElement = document.createElement('div');
                detailElement.className = 'person-detail-row';

                const lists = attendanceData.lists.filter(list =>
                    list.people && list.people.includes(person)
                ).map(list => list.name);

                const functions = attendanceData.personDetails[person]?.functions || [];
                const groupsDisplay = lists.length 
                    ? lists.join(', ') 
                    : '<span class="no-groups">Brak</span>';

                detailElement.innerHTML = `
                    <div class="person-info">
                        <div class="person-name">${person}</div>
                        <div class="person-meta">
                            <div><strong>Podzespoły:</strong> ${groupsDisplay}</div>
                        </div>
                    </div>
                    <div class="function-section">
                        <div class="function-section-title">Przypisane funkcje</div>
                        <div class="function-list">
                            ${functions.map(func => `
                                <span class="function-tag">
                                    ${func}
                                    <button class="remove-function" data-person="${person}" data-function="${func}">×</button>
                                </span>
                            `).join('')}
                        </div>
                        <div class="function-controls">
                            <select class="function-select" data-person="${person}">
                                <option value="">Wybierz funkcję</option>
                                ${attendanceData.functions.map(func => `
                                    <option value="${func}">${func}</option>
                                `).join('')}
                            </select>
                            <button class="assign-function" data-person="${person}">Przypisz funkcję</button>
                        </div>
                    </div>
                `;
                container.appendChild(detailElement);
            });

            document.querySelectorAll('.assign-function').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const person = e.target.dataset.person;
                    const select = document.querySelector(`.function-select[data-person="${person}"]`);
                    const functionName = select.value;

                    if (!functionName) {
                        alert('Proszę wybrać funkcję');
                        return;
                    }

                    if (!attendanceData.personDetails[person]) {
                        attendanceData.personDetails[person] = { functions: [] };
                    }

                    if (!attendanceData.personDetails[person].functions.includes(functionName)) {
                        attendanceData.personDetails[person].functions.push(functionName);
                        saveData();
                        renderPeopleDetails();
                    }

                    select.value = '';
                });
            });

            document.querySelectorAll('.function-tag .remove-function').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const person = e.target.dataset.person;
                    const functionName = e.target.dataset.function;

                    if (attendanceData.personDetails[person] && attendanceData.personDetails[person].functions) {
                        const index = attendanceData.personDetails[person].functions.indexOf(functionName);
                        if (index !== -1) {
                            attendanceData.personDetails[person].functions.splice(index, 1);
                            saveData();
                            renderPeopleDetails();
                        }
                    }
                });
            });
        }

        function renderListFilterOptions() {
            const select = document.getElementById('list-filter');
            select.innerHTML = '<option value="all">Wszystkie listy</option>';

            attendanceData.lists.forEach(list => {
                const option = document.createElement('option');
                option.value = list.id;
                option.textContent = list.name;
                select.appendChild(option);
            });
        }

        function renderListPeopleOptions() {
            const select = document.getElementById('person-to-add');
            select.innerHTML = '<option value="">Wybierz osobę</option>';

            attendanceData.globalPeople.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                select.appendChild(option);
            });
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.target.dataset.page;

                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });

                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                    });

                    document.getElementById(pageId).classList.add('active');
                    e.target.classList.add('active');

                    if (pageId === 'stats') {
                        renderStats();
                    } else if (pageId === 'global-people') {
                        renderGlobalPeople();
                    } else if (pageId === 'people') {
                        renderPeopleDetails();
                    } else if (pageId === 'lists') {
                        renderLists();
                    } else if (pageId === 'functions') {
                        renderFunctions();
                    } else if (pageId === 'excuses') {
                        renderFutureSessions();
                    } else if (pageId === 'export-import') {
                        document.getElementById('export-result').innerHTML = '';
                        document.getElementById('import-result').innerHTML = '';
                    }
                });
            });
        }

        function setupKeyboardShortcuts() {
            document.getElementById('list-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('create-list').click();
                }
            });

            document.getElementById('new-global-person').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('add-global-person').click();
                }
            });

            document.getElementById('session-date').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('add-session').click();
                }
            });

            document.getElementById('person-to-add').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('add-person-to-list').click();
                }
            });

            document.getElementById('new-function').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('add-function').click();
                }
            });
        }

        function setupSessionDateInput() {
            const dateInput = document.getElementById('session-date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            dateInput.focus();
        }

        function setupEventListeners() {
            document.getElementById('create-list').addEventListener('click', () => {
                const listName = document.getElementById('list-name').value.trim();
                if (!listName) {
                    alert('Proszę podać nazwę listy');
                    return;
                }

                const newList = {
                    id: Date.now().toString(),
                    name: listName,
                    people: [],
                    sessions: []
                };

                attendanceData.lists.push(newList);
                saveData();
                renderLists();
                renderListFilterOptions();
                document.getElementById('list-name').value = '';
                alert(`Utworzono nową listę: ${listName}`);
            });

            document.getElementById('add-global-person').addEventListener('click', () => {
                const name = document.getElementById('new-global-person').value.trim();
                if (!name) {
                    alert('Proszę podać imię i nazwisko');
                    return;
                }

                if (attendanceData.globalPeople.includes(name)) {
                    alert('Osoba o tym imieniu i nazwisku już istnieje!');
                    return;
                }

                attendanceData.globalPeople.push(name);

                if (!attendanceData.personDetails[name]) {
                    attendanceData.personDetails[name] = { functions: [] };
                }

                saveData();
                renderGlobalPeople();
                renderListPeopleOptions();
                document.getElementById('new-global-person').value = '';
            });

            document.getElementById('add-function').addEventListener('click', () => {
                const functionName = document.getElementById('new-function').value.trim();
                if (!functionName) {
                    alert('Proszę podać nazwę funkcji');
                    return;
                }

                if (attendanceData.functions.includes(functionName)) {
                    alert('Funkcja o tej nazwie już istnieje!');
                    return;
                }

                attendanceData.functions.push(functionName);
                saveData();
                renderFunctions();
                document.getElementById('new-function').value = '';
            });

            document.getElementById('add-person-to-list').addEventListener('click', () => {
                const person = document.getElementById('person-to-add').value.trim();
                if (!person) {
                    alert('Proszę wybrać osobę');
                    return;
                }

                const list = attendanceData.lists.find(l => l.id === currentState.activeListId);
                if (list) {
                    if (!list.people) list.people = [];

                    if (list.people.includes(person)) {
                        alert('Osoba jest już na liście!');
                        return;
                    }

                    list.people.push(person);
                    saveData();
                    renderPeopleList();
                    renderPeopleDetails();
                }
            });

            document.getElementById('add-session').addEventListener('click', () => {
                const date = document.getElementById('session-date').value;
                if (!date) {
                    alert('Proszę wybrać datę sesji');
                    return;
                }

                const list = attendanceData.lists.find(l => l.id === currentState.activeListId);
                if (!list) return;

                if (list.sessions.some(s => s.date === date)) {
                    alert('Sesja dla tej daty już istnieje!');
                    return;
                }

                const newSession = {
                    date: date,
                    attendance: {}
                };

                if (list.people) {
                    list.people.forEach(person => {
                        // Domyślnie ustaw status "nie brany"
                        newSession.attendance[person] = 'not_taken';
                    });
                }

                if (!list.sessions) list.sessions = [];
                list.sessions.push(newSession);
                saveData();
                renderSessions();
                setupSessionDateInput();
            });

            document.getElementById('apply-filter').addEventListener('click', renderStats);
            
            // Dodane przyciski zapisu i wczytania
            document.getElementById('save-data-btn').addEventListener('click', saveToFirebase);
            document.getElementById('load-data-btn').addEventListener('click', loadFromFirebase);
        }

        function openList(listId) {
            const list = attendanceData.lists.find(l => l.id === listId);
            if (!list) return;

            currentState.activeListId = listId;
            document.getElementById('current-list-name').textContent = `Zarządzanie listą: ${list.name}`;

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('manage-list').classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            if (!list.people) list.people = [];
            if (!list.sessions) list.sessions = [];

            renderListPeopleOptions();
            renderPeopleList();
            renderSessions();
        }

        function renderPeopleList() {
            const list = attendanceData.lists.find(l => l.id === currentState.activeListId);
            if (!list) return;

            const tbody = document.getElementById('people-list-body');
            tbody.innerHTML = '';

            list.people.forEach((person, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${person}</td>
                    <td>
                        <button class="remove-person" data-index="${index}">Usuń</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.querySelectorAll('.remove-person').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const person = list.people[index];

                    // Usuń osobę z sesji
                    list.sessions.forEach(session => {
                        if (session.attendance && session.attendance[person]) {
                            delete session.attendance[person];
                        }
                    });

                    // Usuń osobę z listy
                    list.people.splice(index, 1);
                    saveData();
                    renderPeopleList();
                    renderSessions();
                    renderPeopleDetails();
                });
            });
        }

        function openSession(sessionIndex) {
            const list = attendanceData.lists.find(l => l.id === currentState.activeListId);
            if (!list || !list.sessions[sessionIndex]) return;

            currentState.currentSession = sessionIndex;
            const session = list.sessions[sessionIndex];

            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';

            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.width = '90%';
            modalContent.style.maxWidth = '800px';
            modalContent.style.maxHeight = '90vh';
            modalContent.style.overflowY = 'auto';

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Obecność: ${session.date}</h2>
                    <button id="close-modal" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">×</button>
                </div>
                <p>Lista: ${list.name}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Osoba</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="session-attendance-body"></tbody>
                </table>
                <div style="margin-top: 20px; text-align: right;">
                    <button id="save-session">Zapisz zmiany</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            const tbody = document.getElementById('session-attendance-body');
            tbody.innerHTML = '';

            list.people.forEach(person => {
                const row = document.createElement('tr');
                // Domyślnie "nie brany" jeśli status nie jest ustawiony
                const status = session.attendance[person] || 'not_taken';

                row.innerHTML = `
                    <td>${person}</td>
                    <td>
                        <select class="person-attendance" data-person="${person}">
                            <option value="not_taken" ${status === 'not_taken' ? 'selected' : ''}>Nie brany</option>
                            <option value="present" ${status === 'present' ? 'selected' : ''}>Obecny</option>
                            <option value="absent" ${status === 'absent' ? 'selected' : ''}>Nieobecny</option>
                            <option value="excused" ${status === 'excused' ? 'selected' : ''}>Usprawiedliwiony</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            document.getElementById('save-session').addEventListener('click', () => {
                document.querySelectorAll('.person-attendance').forEach(select => {
                    const person = select.dataset.person;
                    const status = select.value;
                    session.attendance[person] = status;
                });

                saveData();
                alert('Zmiany zostały zapisane!');
                document.body.removeChild(modal);
                renderSessions();
            });
        }

        function renderStats() {
            const tbody = document.getElementById('stats-body');
            tbody.innerHTML = '';

            const period = document.getElementById('period').value;
            const listFilter = document.getElementById('list-filter').value;
            const today = new Date();
            const periodStart = new Date(today);

            if (period === '1') {
                periodStart.setMonth(periodStart.getMonth() - 1);
            } else if (period === '2') {
                periodStart.setMonth(periodStart.getMonth() - 2);
            } else if (period === '3') {
                periodStart.setMonth(periodStart.getMonth() - 3);
            } else if (period === '6') {
                periodStart.setMonth(periodStart.getMonth() - 6);
            }

            const stats = {};

            attendanceData.lists.forEach(list => {
                if (listFilter !== 'all' && list.id !== listFilter) {
                    return;
                }

                if (list.sessions) {
                    list.sessions.forEach(session => {
                        const sessionDate = new Date(session.date);

                        if (period !== 'all' && sessionDate < periodStart) {
                            return;
                        }

                        if (session.attendance) {
                            Object.entries(session.attendance).forEach(([person, status]) => {
                                // Pomijamy status "nie brany" w statystykach
                                if (status === 'not_taken') return;
                                
                                if (!stats[person]) {
                                    stats[person] = {
                                        person: person,
                                        present: 0,
                                        absent: 0,
                                        excused: 0
                                    };
                                }

                                if (status === 'present') {
                                    stats[person].present++;
                                } else if (status === 'absent') {
                                    stats[person].absent++;
                                } else if (status === 'excused') {
                                    stats[person].excused++;
                                }
                            });
                        }
                    });
                }
            });

            const statsArray = Object.values(stats).sort((a, b) => b.absent - a.absent);

            statsArray.forEach(data => {
                const row = document.createElement('tr');
                const warning = data.absent >= 3 ? '<span class="warning-icon">⚠️</span>' : '';
                const absentClass = data.absent < 3 ? 'absent-badge' : 'absent-high-badge';

                row.innerHTML = `
                    <td>${data.person}</td>
                    <td>
                        <span class="badge-circle present-badge">${data.present}</span>
                    </td>
                    <td>
                        <span class="badge-circle ${absentClass}">${data.absent}</span>
                    </td>
                    <td>
                        <span class="badge-circle excused-badge">${data.excused}</span>
                    </td>
                    <td>${warning}</td>
                `;
                tbody.appendChild(row);
            });

            if (statsArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Brak danych w wybranym okresie</td></tr>';
            }
        }

        function deleteList(listId) {
            if (!confirm('Czy na pewno chcesz usunąć tę listę?')) return;

            attendanceData.lists = attendanceData.lists.filter(list => list.id !== listId);
            saveData();
            renderLists();
            renderListFilterOptions();
            renderPeopleDetails();
        }

        function renderSessions() {
            const container = document.getElementById('sessions-container');
            container.innerHTML = '';

            const list = attendanceData.lists.find(l => l.id === currentState.activeListId);
            if (!list || !list.sessions) return;

            if (list.sessions.length === 0) {
                container.innerHTML = '<p>Brak sesji. Dodaj nową sesję.</p>';
                return;
            }

            list.sessions.sort((a, b) => new Date(b.date) - new Date(a.date));

            list.sessions.forEach((session, index) => {
                const sessionElement = document.createElement('div');
                sessionElement.className = 'session-item';
                sessionElement.dataset.index = index;

                let presentCount = 0;
                let absentCount = 0;
                let excusedCount = 0;
                let notTakenCount = 0;

                if (session.attendance) {
                    Object.values(session.attendance).forEach(status => {
                        if (status === 'present') presentCount++;
                        else if (status === 'absent') absentCount++;
                        else if (status === 'excused') excusedCount++;
                        else if (status === 'not_taken') notTakenCount++;
                    });
                }

                sessionElement.innerHTML = `
                    <div>
                        <strong>${session.date}</strong>
                        <div>
                            <span class="attendance-present">Obecni: ${presentCount}</span> | 
                            <span class="attendance-absent">Nieobecni: ${absentCount}</span> |
                            <span class="attendance-excused">Usprawiedliwieni: ${excusedCount}</span> |
                            <span class="attendance-not-taken">Nie brani: ${notTakenCount}</span>
                        </div>
                    </div>
                    <div>
                        <button class="delete-session" data-index="${index}">Usuń</button>
                    </div>
                `;
                container.appendChild(sessionElement);

                sessionElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-session')) {
                        openSession(index);
                    }
                });
            });

            document.querySelectorAll('.delete-session').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const sessionIndex = parseInt(e.target.dataset.index);
                    if (confirm('Czy na pewno chcesz usunąć tę sesję?')) {
                        list.sessions.splice(sessionIndex, 1);
                        saveData();
                        renderSessions();
                    }
                });
            });
        }

        function renderFutureSessions() {
            const container = document.getElementById('future-sessions-container');
            container.innerHTML = '';

            const today = new Date().toISOString().split('T')[0];
            let hasFutureSessions = false;

            attendanceData.lists.forEach(list => {
                if (list.sessions) {
                    list.sessions.forEach(session => {
                        if (session.date >= today) {
                            hasFutureSessions = true;

                            const containerId = `excuse-container-${list.id}-${session.date}`;
                            const excuseCard = document.createElement('div');
                            excuseCard.className = 'excuse-card';

                            excuseCard.innerHTML = `
                                <div class="excuse-card-header">
                                    <div class="excuse-card-title">${list.name}</div>
                                    <div class="excuse-card-date">${session.date}</div>
                                </div>
                                <div class="excuse-card-body">
                                    <label>Osoby do usprawiedliwienia:</label>
                                    <div class="select-all-buttons">
                                        <button class="select-all-btn" data-container="${containerId}">Zaznacz wszystkie</button>
                                        <button class="deselect-all-btn" data-container="${containerId}">Odznacz wszystkie</button>
                                    </div>
                                    <div id="${containerId}" class="excuse-list">
                                        ${list.people ? list.people.map(person => {
                                const status = session.attendance[person] || 'not_taken';
                                
                                // Pomijamy osoby z statusem "nie brany"
                                if (status === 'not_taken') return '';
                                
                                const isExcused = status === 'excused';
                                return `
                                                <div class="excuse-item">
                                                    <input type="checkbox" id="excuse-${list.id}-${session.date}-${person}" 
                                                        value="${person}" ${isExcused ? 'checked' : ''}>
                                                    <label for="excuse-${list.id}-${session.date}-${person}">${person}</label>
                                                </div>
                                            `;
                            }).join('') : ''}
                                    </div>
                                    <button class="save-excuse" data-list="${list.id}" data-date="${session.date}">Zapisz usprawiedliwienia</button>
                                </div>
                            `;

                            container.appendChild(excuseCard);
                        }
                    });
                }
            });

            if (!hasFutureSessions) {
                container.innerHTML = `
                    <div class="no-future-sessions">
                        <p>Brak nadchodzących sesji.</p>
                        <p>Dodaj sesje z przyszłymi datami w zakładce "Listy obecności".</p>
                    </div>
                `;
            }

            document.querySelectorAll('.save-excuse').forEach(btn => {
                btn.addEventListener('click', function () {
                    const listId = this.dataset.list;
                    const sessionDate = this.dataset.date;
                    const list = attendanceData.lists.find(l => l.id === listId);
                    if (!list || !list.sessions) return;

                    const session = list.sessions.find(s => s.date === sessionDate);
                    if (!session) return;

                    const selectedPersons = [];
                    const checkboxes = document.querySelectorAll(`input[type="checkbox"][value][id^="excuse-${listId}-${sessionDate}"]`);
                    checkboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            selectedPersons.push(checkbox.value);
                        }
                    });

                    list.people.forEach(person => {
                        const status = session.attendance[person] || 'not_taken';
                        
                        // Pomijamy osoby z statusem "nie brany"
                        if (status === 'not_taken') return;
                        
                        if (selectedPersons.includes(person)) {
                            session.attendance[person] = 'excused';
                        } else if (session.attendance[person] === 'excused') {
                            session.attendance[person] = 'present';
                        }
                    });

                    saveData();
                    alert('Zapisano usprawiedliwienia!');
                });
            });

            document.querySelectorAll('.select-all-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const containerId = this.dataset.container;
                    const container = document.getElementById(containerId);
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                });
            });

            document.querySelectorAll('.deselect-all-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const containerId = this.dataset.container;
                    const container = document.getElementById(containerId);
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                });
            });
        }

        // =============================================
        // EKSPORT/IMPORT DANYCH
        // =============================================
        document.getElementById('export-data').addEventListener('click', () => {
            const dataToExport = { ...attendanceData };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_data_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('export-result').innerHTML = 
                '<p style="color: green;">Dane wyeksportowane pomyślnie!</p>';
        });

        document.getElementById('import-data').addEventListener('click', () => {
            const fileInput = document.getElementById('import-file');
            const importResult = document.getElementById('import-result');
            
            if (!fileInput.files.length) {
                importResult.innerHTML = '<p style="color: red;">Wybierz plik do importu!</p>';
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!confirm('Czy na pewno chcesz zaimportować dane? Wszystkie bieżące dane zostaną nadpisane.')) {
                        importResult.innerHTML = '<p style="color: orange;">Import anulowany</p>';
                        return;
                    }
                    
                    attendanceData = importedData;
                    saveLocalData();
                    renderAll();
                    
                    importResult.innerHTML = `
                        <p style="color: green;">Dane zaimportowane pomyślnie!</p>
                        <p>Zaimportowano:
                            <br>• Listy: ${importedData.lists.length}
                            <br>• Osoby: ${importedData.globalPeople.length}
                            <br>• Funkcje: ${importedData.functions.length}
                        </p>
                    `;
                    
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    document.getElementById('lists').classList.add('active');
                    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                    document.querySelector(`.nav-link[data-page="lists"]`).classList.add('active');
                    
                } catch (error) {
                    importResult.innerHTML = `<p style="color: red;">Błąd importu: ${error.message}</p>`;
                }
            };
            
            reader.readAsText(file);
        });

        // =============================================
        // INICJALIZACJA
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Inicjalizacja przycisków autoryzacji
            document.getElementById('sign-in-btn').addEventListener('click', signIn);
            document.getElementById('sign-out-btn').addEventListener('click', signOut);
            
            // Monitorowanie połączenia
            firebaseDatabase.ref('.info/connected').on('value', (snapshot) => {
                const status = document.getElementById('connection-status');
                if (snapshot.val() === true) {
                    status.textContent = 'Online';
                    status.style.backgroundColor = '#4CAF50';
                } else {
                    status.textContent = 'Offline - praca lokalna';
                    status.style.backgroundColor = '#f44336';
                }
            });

            // Inicjalizacja aplikacji
            renderLists();
            renderGlobalPeople();
            renderFunctions();
            setupNavigation();
            setupEventListeners();
            renderListFilterOptions();
            setupKeyboardShortcuts();
            setupSessionDateInput();
        });
    </script>
</body>
</html>
